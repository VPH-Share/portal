{% extends 'scs/base.html' %}
{% load scs_extras %}
{%  block title %} Manage Data {% endblock %}

{% block extrahead %}
    <link rel="stylesheet" href="/static/font-awesome.min.css">
    <!--[if IE 7]>
    <link rel="stylesheet" href="/static/font-awesome-ie7.min.css">
    <![endif]-->
{% endblock %}

{% block page-title %}
    <span class="title">Manage Data</span>
    <span class="subtitle">&nbsp</span>
{% endblock%}

{%  block content %}
    <div class="row">
        <div class="span12">

            <div class="accordion" id="accordion2">

                    <div class="accordion-group accordion-manage-data">
                        <div class="accordion-heading">
                            <a class="accordion-toggle collapse-manage-data" data-toggle="collapse" data-parent="#accordion2" href="#datas">
                                <h4>My Data </h4>
                                <span class="icon-chevron-down pull-right"></span>
                            </a>
                        </div>
                        <div id="datas" class="accordion-body collapse">
                            &nbsp
                        {% for resource in datas %}
                            <div class="row row-manage-data">
                                <div class="span3">{{ resource.metadata.name }}</div>
                                <div class="span3">Author: {{ resource.metadata.author }} </div>
                                <div class="span3">Published: {{ resource.metadata.creation_date }}</div>
                                <div class="span2">
                                    <span class="icon icon-share-alt" style="padding-right: 25px;"></span>
                                    <a href="#modal-{{ resource.id }}" role="button" data-toggle="modal"><span class="icon icon-cog" style="padding-right: 25px;"></span></a>
                                    <a href="#share-{{ resource.id }}" role="button" data-toggle="modal"><span class="icon  icon-group" ></span></a>
                                </div>

                                {% include 'scs_resources/manage_widget.html' %}
                                {% include 'scs_resources/share_widget.html' %}
                            </div>
                        {% endfor %}
                        </div>
                    </div>

                    <div class="accordion-group accordion-manage-data">
                        <div class="accordion-heading">
                            <a class="accordion-toggle collapse-manage-data" data-toggle="collapse" data-parent="#accordion2" href="#applications">
                                <h4>My Applications </h4>
                                <span class="icon-chevron-down pull-right"></span>
                            </a>
                        </div>
                        <div id="applications" class="accordion-body collapse">
                            &nbsp
                        {% for resource in applications %}
                            <div class="row row-manage-data">
                                <div class="span3">{{ resource.metadata.name }}</div>
                                <div class="span3">Author: {{ resource.metadata.author }} </div>
                                <div class="span3">Published: {{ resource.metadata.creation_date }}</div>
                                <div class="span2">
                                    <span class="icon icon-share-alt" style="padding-right: 25px;"></span>
                                    <a href="#modal-{{ resource.id }}" role="button" data-toggle="modal"><span class="icon icon-cog" style="padding-right: 25px;"></span></a>
                                    <a href="#share-{{ resource.id }}" role="button" data-toggle="modal"><span class="icon  icon-group" ></span></a>
                                </div>

                                {% include 'scs_resources/manage_widget.html' %}
                                {% include 'scs_resources/share_widget.html' %}
                            </div>
                        {% endfor %}
                        </div>
                    </div>

                    <div class="accordion-group accordion-manage-data">
                        <div class="accordion-heading">
                            <a class="accordion-toggle collapse-manage-data" data-toggle="collapse" data-parent="#accordion2" href="#workflows">
                                <h4>My Workflows</h4>
                                <span class="icon-chevron-down pull-right"></span>
                            </a>
                        </div>
                        <div id="workflows" class="accordion-body collapse">
                            &nbsp
                        {% for resource in workflows %}
                            <div class="row row-manage-data">
                                <div class="span3">{{ resource.metadata.name }}</div>
                                <div class="span3">Author: {{ resource.metadata.author }} </div>
                                <div class="span3">Published: {{ resource.metadata.creation_date }}</div>
                                <div class="span2">
                                    <span class="icon icon-share-alt" style="padding-right: 25px;"></span>
                                    <a href="#modal-{{ resource.id }}" role="button" data-toggle="modal"><span class="icon icon-cog" style="padding-right: 25px;"></span></a>
                                    <a href="#share-{{ resource.id }}" role="button" data-toggle="modal"><span class="icon  icon-group" ></span></a>
                                </div>

                                {% include 'scs_resources/manage_widget.html' %}
                                {% include 'scs_resources/share_widget.html' %}
                            </div>
                        {% endfor %}
                        </div>
                    </div>

            </div>
        </div>
    </div>
    <script type="text/javascript">

        (function() {
            var global = this;
            var $ = global.$;
            var console = global.console || {log:function() {}};


            var ManageModal = global.ManageModal = function(element, options) {
                this.inizialize($(element));
            };

            ManageModal.prototype.inizialize = function(manageModal){
                var self = this;
                this.$globalId = manageModal.data('globalid');
                this.$editDescriptionBtn = manageModal.find('#edit-description-btn');
                this.$description = manageModal.find('#edit-description-textarea');
                this.$updateDescriptionBtn = manageModal.find('#update-description');
                this.$editDescriptionForm = manageModal.find('#edit-description-form');
                this.$tag = manageModal.find('.tag');
                this.$removeTag = manageModal.find('#remove-tag');
                this.$enterTagForm = manageModal.find('#enter-tag-form');
                this.$enterTagBtn = manageModal.find('#enter-tag-btn');
                this.$tagInput = manageModal.find('#enter-tag-input');
                this.$updateTagBtn = manageModal.find('#update-tag');
                this.$modalDescription = manageModal.find('#modal-description');
                this.$alert = manageModal.find('.alert');

                this.$editDescriptionBtn.click(function(e){self.editDescription(e);});
                this.$updateDescriptionBtn.click(function(e){self.updateDescription(e);});
                this.$removeTag.click(function(e){self.removeTag(e,$(this).parent('.tag-label').find('.tag'));});
                this.$enterTagBtn.click(function(e){self.enterTag(e);});
                this.$updateTagBtn.click(function(e){self.updateTag(e);});

            };

            ManageModal.prototype.alert = function(message,style){
                style = "alert-"+style;

                this.$alert.find('#modal-message').text(message);
                this.$alert.addClass(style);
                this.$alert.fadeIn().delay(3000).fadeOut(1000, function(){
                    $(this).removeClass(style).find('#modal-message').text('');
                });
            };

            ManageModal.prototype.editDescription = function(e){
                this.$editDescriptionBtn.hide();
                this.$modalDescription.hide();
                this.$editDescriptionForm.show();
            };

            ManageModal.prototype.updateDescriptionError = function(e){
                this.$editDescriptionBtn.show();
                this.$modalDescription.show();
                this.$editDescriptionForm.hide();
                this.alert("Error! Service don't not accept your request.","error");
                this.$updateDescriptionBtn.button('reset');
            };

            ManageModal.prototype.updateDescriptionCallBack = function(e){
                this.$modalDescription.text(this.$description.val());
                this.$editDescriptionBtn.show();
                this.$modalDescription.show();
                this.$editDescriptionForm.hide();
                this.alert("Done! Description updated.","success");
                this.$updateDescriptionBtn.button('reset');
            };

            ManageModal.prototype.updateDescription = function(e){
                this.$updateDescriptionBtn.button('loading');
                var self = this;
                var description = this.$description.val();

                $.ajax('/update_description/', {
                    data: {global_id:self.$globalId, description: description},
                    type: 'POST',
                    success: function(data) { self.updateDescriptionCallBack(data); },
                    error: function(data) { self.updateDescriptionError(data); }
                });
            };

            ManageModal.prototype.removeTagError = function(e){
                this.alert("Error! Service don't not accept your request.","error");
            };

            ManageModal.prototype.removeTagCallBack = function(e, tag){
                tag.parent('.tag-label').remove();
                this.alert("Done! Tag removed.","success");
            };

            ManageModal.prototype.removeTag = function(e, tag){
                var self = this;
                var removedTag = tag.text();

                $.ajax('/delete_tag/', {
                    data: {global_id:self.$globalId, tag: removedTag},
                    type: 'POST',
                    success: function(data) { self.removeTagCallBack(data, tag); },
                    error: function(data) { self.removeTagError(data); }
                });
            };

            ManageModal.prototype.enterTag = function(e){
                this.$enterTagBtn.hide();
                this.$enterTagForm.show();
            };

            ManageModal.prototype.updateTagError = function(e){
                this.$enterTagBtn.show();
                this.$enterTagForm.hide();
                this.alert("Error! Service don't not accept your request.","error");
                this.$updateTagBtn.button('reset');
            };

            ManageModal.prototype.updateTagCallBack = function(tag){
                var self = this;
                var newTag = $("<span class=\"label tag-label\" style=\"vertical-align: middle;margin-right: 5px;\"><div class=\"tag pull-left\">"+tag+"</div><div id=\"remove-tag\" type=\"button\" class=\"close pull-rigth\" style=\"margin-left:5px;line-height: 14px\">×</div></span>");
                newTag.insertBefore(this.$enterTagBtn);
                newTag.find('#remove-tag').click(function(e){self.removeTag(e,$(this).parent('.tag-label').find('.tag'));});
                this.$enterTagBtn.show();
                this.$enterTagForm.hide();
                this.alert("Done! Tags updated","success");
                this.$updateTagBtn.button('reset');
            };

            ManageModal.prototype.updateTag = function(e){
                this.$updateTagBtn.button('loading');
                var self = this;
                var tag = this.$tagInput.val();

                $.ajax('/update_tag/', {
                    data: {global_id:self.$globalId, tag: tag},
                    type: 'POST',
                    success: function(data) { self.updateTagCallBack(tag); },
                    error: function(data) { self.updateTagError(data); }
                });
            };


            ManageModal.autoDiscover = function() {
                $('.manage-modal-data').each(function(index, element) {
                    new ManageModal(element);
                });

            };
            ManageModal.autoDiscover();
        }).call(this);


    </script>

{% endblock %}
