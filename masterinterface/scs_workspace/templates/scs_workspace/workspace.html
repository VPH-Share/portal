{% extends 'scs/base.html' %}

{% load scs_extras %}
{%  block title %} Workspace {% endblock %}

{% block extrahead %}
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
{% endblock %}

{% block page-title %}
    <span class="title">Workspace</span>
{% endblock%}

{% block content %}
<div>
<ul class="nav nav-pills">
  <li class="active">
      <a>
      Workflow executions
      </a>
  </li>
</ul>
</div>
{% for execution in executions%}
<div id="{{ execution.id }}"  class="execution well well-small">
    <div class="row">
        <div  class="span4">
        {{ execution.title }}
        </div>
        <div class="span5">
        Status:<div id="{{ execution.id }}-status" style="display: inline-block" class="inline"> {{ execution.status }}</div>

        </div>

        <div class="span2">
            <div class="btn-group">
                <button id="play-button" class="btn btn-success btn-mini" title="Run workflow"  data-loading-text="<i class='icon-spinner icon-spin'></i>" >
                        <i class="icon-play"></i>
                </button>
                <button id="delete-button" class="btn btn-danger btn-mini" data-loading-text="<i class='icon-spinner icon-spin'></i>" title="Delete workflow">
                    <i class="icon-remove"></i>
                </button>
                <a class="btn btn-warning btn-mini accordion-toggle " title="Show details" data-toggle="collapse" href="#{{ execution.id }}-details">
                    <i class="icon-reorder"></i>
                </a>
            </div>
        </div>
    </div>
        <div class="alert hide" style="display: none;">
                <button type="button" class="close" data-dismiss="alert">Ã—</button>
                <span id="modal-message"></span>
        </div>
    <div id="{{ execution.id }}-details" class="accordion-body collapse">
        <ul class="nav nav-tabs" id="details-tab">
          <li class="active">
            <a href="#{{ execution.id }}-status-info" data-toggle="tab">Status</a>
          </li>
          <li><a href="#{{ execution.id }}-status-details" data-toggle="tab">Details</a></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane active" id="{{ execution.id }}-status-info">
              <div class="alert"></div>
              <div class="alert"></div>
              <div class="alert"></div>
              <div class="alert"></div>
              <div class="alert"></div>
              <div class="alert"></div>
              <div class="alert"></div>
              <div class="alert"></div>
              <div class="alert"></div>
          </div>
          <div class="tab-pane " id="{{ execution.id }}-status-details">
              <div class="alert">&nbsp; test</div>
          </div>
        </div>
     </div>
</div>
{% endfor %}



<script type="text/javascript">


        (function() {
            var global = this;
            var $ = global.$;
            var console = global.console || {log:function() {}};

            var statusMessage = [
                    'Created.',
                    ['Initializing Atomic service.', 'Atomic service is initialized.'],
                    ['Starting Atomic service.', 'Atomic service is started.'],
                    ['Waiting for taverna.', 'Taverna is ready.'],
                    ['Submitting  the workflow to Taverna.', 'The workflow is submited.'],
                    ['Configuring the workflow.', 'Workflow is ready.'],
                    'Starting the Workflow.',
                    'Workflow is running.',
                    'Finished.'
            ];
            var WfmngProtocol = global.WfmngProtocol = function(element, options) {
                this.inizialize($(element));
            };

            WfmngProtocol.prototype.inizialize = function(wfmngProtocol){
                var self = this;
                this.$executionId = wfmngProtocol.attr('id');
                this.$playButton = wfmngProtocol.find('#play-button');
                this.$deleteButton = wfmngProtocol.find('#delete-button');
                this.$details = wfmngProtocol.find('#'+this.$executionId+'-status-details');
                this.$status = wfmngProtocol.find('#'+this.$executionId+'-status');
                this.$statusInfo = wfmngProtocol.find('#'+this.$executionId+'-status-info');
                this.$timeoutid = 0;
                this.$playButton.click(function(){
                    self.startTaverna($(this));
                });
                this.$deleteButton.click(function(){
                   self.deleteWorkflow();
                });
                this.getExecutioninfo();
                this.$alert = wfmngProtocol.find('.alert');
            };

            WfmngProtocol.prototype.alert = function(message,style){
                style = "alert-"+style;

                this.$alert.find('#modal-message').text(message);
                this.$alert.addClass(style);
                this.$alert.fadeIn();
            };


            WfmngProtocol.prototype.startTaverna = function(element){
                var self = this;
                this.$playButton.button('loading');
                $.ajax({
                            dataType: "json",
                            type: 'post',
                            url: '/workspace/startExecution',
                            data: {eid:self.$executionId},
                            success: function(data){return;},
                            error: function(data){return;}
                        }
                );
                this.$timeoutid = window.setTimeout(function(){self.getExecutioninfo()}, 5000);
            };

            WfmngProtocol.prototype.deleteWorkflowCallBack = function(data){

                if (data.results == 'true'){
                    $("#"+this.$executionId).remove();
                    delete this;
                }

                this.alert('Error occurs during workflow deletion','error');

            };

            WfmngProtocol.prototype.deleteWorkflow = function(){
                var self = this;
                this.$playButton.button('loading');
                $.ajax({
                            dataType: "json",
                            type: 'post',
                            url: '/workspace/deleteExecution',
                            data: {eid:self.$executionId},
                            success: function(data){self.deleteWorkflowCallBack(data)},
                            error: function(data){return;}
                        }
                );
            };

            WfmngProtocol.prototype.getExecutioninfoCallBack = function(data){
                var self = this;
                var label = ["executionstatus",'error','error_msg',"Taverna workflow id"," Taverna url","AS config id ", " Created"," Session Expire"," Execution started"," Execution finished"," Exit code"," Std output"," Std error","Output folder"];
                this.$details.empty();
                var error = data[1];
                var error_msg = data[2];
                var executionStatusCode = parseInt(data[0]);

                if(executionStatusCode<8 && !error){
                    if(executionStatusCode>0)
                        this.$playButton.button('loading');
                    if (this.$timeoutid == 0)
                        this.$timeoutid = window.setTimeout(function(){self.getExecutioninfo()}, 5000);
                }else{
                    window.clearTimeout(this.$timeoutid);
                    this.$playButton.button('reset');
                    this.$timeoutid = 0;
                }
                var alerts = this.$statusInfo.children('.alert');
                for (var j=0; j<9; j++){
                    if (executionStatusCode == j){
                        if (error){
                            this.$status.text(error_msg);
                            $(alerts[j]).html(error_msg + "<i class='icon-warning'></i>");
                        }else if ($.isArray(statusMessage[j])){
                            this.$status.text(statusMessage[j][0]);
                        }else{
                            this.$status.text(statusMessage[j]);
                        }
                        $(alerts[j]).toggleClass( "alert-info", executionStatusCode == j && !error );
                        $(alerts[j]).toggleClass( "alert-error", executionStatusCode == j && error );
                        if(j==0 || j==8){
                            $(alerts[j]).html(this.$status.text()+"<i class='icon-check'></i>");
                        }else{
                            $(alerts[j]).html(this.$status.text()+"<i class='icon-spinner icon-spin'></i>");
                        }
                    }else if (executionStatusCode > j){
                        if ($.isArray(statusMessage[j])){
                            $(alerts[j]).html(statusMessage[j][1]+"<i class='icon-check'></i>");
                        }else{
                            $(alerts[j]).html(statusMessage[j]+"<i class='icon-check'></i>");
                        }
                        $(alerts[j]).toggleClass( "alert-success", executionStatusCode > j );
                    }else{
                        if ($.isArray(statusMessage[j])){
                            $(alerts[j]).html(statusMessage[j][0]);
                        }else{
                            $(alerts[j]).html(statusMessage[j]);
                        }
                        $(alerts[j]).toggleClass( "alert-disable", executionStatusCode < j);
                    }
                }

                for (var i=3; i<data.length;i++){

                    if (data[i] != ''){
                        if (i == 11 || i == 12){
                            this.$details.append('<p><strong>'+label[i]+'</strong> <textarea readonly rows="10" style="width:90%">'+data[i]+'</textarea></p>');

                        }else if(i==13){
                            this.$details.append('<p> <a href="/lobcder'+data[i]+'">'+label[i]+'</a></p>');
                        }else{
                            this.$details.append('<p><strong>'+label[i]+'</strong> <span>'+data[i]+'</span></p>');
                        }
                    }
                }
            };

            WfmngProtocol.prototype.getExecutioninfo = function(){
                var self = this;
                $.ajax({
                            dataType: "json",
                            type: 'post',
                            url: '/workspace/getExecutionInfo',
                            data: {eid:self.$executionId},
                            success: function(data){
                                self.getExecutioninfoCallBack(data)
                            },
                            error: function(data){
                                return;
                            }
                        }
                );
            };

            WfmngProtocol.autoDiscover = function() {
                $('.execution').each(function(index, element) {
                    new WfmngProtocol(element);
                });

            };
            WfmngProtocol.autoDiscover();
        }).call(this);
    </script>

{% endblock %}