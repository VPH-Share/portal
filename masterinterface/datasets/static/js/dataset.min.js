(function(){var a,b,c;a=this;b=a.$;c=a.QueryBuilder=function(e,d){this.inizialize(e)};c.prototype.inizialize=function(d){var e=this;this.$columnsList={};this.$dropArea={select:[],where:[]};this.$root=d;this.$globalID=d.data("globalid");this.$queryid=d.data("queryid");b("#query_button").click(function(){b("#query_button").button("loading");e.submit_query()});b("#saveas-query").click(function(){e.saveAsQuery()});b("#save-query").click(function(){e.saveQuery()});b(".query-list").each(function(f,h){var g=b(h);g.bind("close",function(){var j=b(this);var k=g.data("queryid");var i=g.data("name");if(confirm("Are you sure you want to delete "+i+" query?")){b.ajax({type:"POST",url:"/delete_the_query/",dataType:"json",data:{globalID:e.$globalID,q:k,name:i},success:function(l){if(l.deleted){return true}},fail:function(l){alert("Some errors occurs, retry")}});return true}else{return false}})});d.find("input,select,textarea").not("[type=submit]").jqBootstrapValidation();d.find(".input-date").each(function(f,g){b(g).datetimepicker({clearBtn:false,autoclose:true,format:"dd/mm/yyyy hh:ii"})});d.find(".input-datetime").each(function(f,g){b(g).datetimepicker({minView:2,autoclose:true,clearBtn:false,startView:2,format:"dd/mm/yyyy"})});d.find(".input-time").each(function(f,g){b(g).datetimepicker({minView:0,format:"hh:ii",clearBtn:false,maxView:1,autoclose:true,startView:1})});d.find(".column").each(function(g,h){var f=b(h);e.$columnsList[f.attr("id")]={name:f.data("name"),type:f.data("type"),tablename:f.data("tablename")};f.draggable({revert:"invalid",revertDuration:200,zIndex:2500,cursor:"move",helper:"clone",appendTo:"body",cursorAt:{top:17,left:15},start:function(i,j){},drag:function(i,j){}})});d.find(".condition:not(.new-condition)").droppable({activeClass:"new-condition-active",hoverClass:"condition-hover",drop:function(f,g){e.drop_new_single_operation(f,g,b(this))}});d.find(".new-condition").droppable({activeClass:"new-condition-active",hoverClass:"condition-hover",drop:function(f,g){e.drop_new_condition(f,g,b(this))}});d.find(".new-select").droppable({activeClass:"new-condition-active",hoverClass:"condition-hover",drop:function(f,g){e.drop_new_select(f,g,b(this))}});d.find(".close").tooltip();d.find(".connector").click(e.changeConnector);e.loadtables();if(this.$queryid!=""){b("#query_button").button("loading");e.submit_query()}d.find("select").change(function(){var f=b(this).val();if(b.inArray(f,["isnull","isnotnull"])>-1){b(this).next().hide();b(this).next().val("1")}else{if(b(this).next()=="none"){b(this).next().val("")}b(this).next().show()}})};c.prototype.changeConnector=function(){var d=b(this);if(d.hasClass("and")){d.removeClass("and").addClass("or")}else{d.removeClass("or").addClass("and")}};c.drop_new_operation=function(e,d){if(e.find(".connector").length){e.children(".connector").before(d)}else{e.append(d)}};c.prototype.drop_new_single_operation=function(e,l,j){var o=this;var n=b(l.draggable).clone();var f=n.data("name");var k=n.data("type");var g=n.attr("id");var i=n.data("tablename");var d="";var m="";var p="";if(b.inArray(k,["smallint","int","bigint"])>-1){d=ich.numeric_options()[0].outerHTML;p="numeric";m=ich.integer_value({name:f})[0].outerHTML}else{if(b.inArray(k,["double","float"])>-1){d=ich.numeric_options()[0].outerHTML;p="numeric";m=ich.float_value({name:f})[0].outerHTML}else{if(b.inArray(k,["date","time","dateTime"])>-1){p=k.toLowerCase();d=ich.numeric_options()[0].outerHTML;m=ich.datetime_value({name:f})[0].outerHTML}else{d=ich.string_options()[0].outerHTML;m=ich.text_value({name:f})[0].outerHTML;p="string"}}}var h=ich.inside_condition({left_node:n.html(),operations:d,input:m});h.find("select").change(function(){var q=b(this).val();if(b.inArray(q,["isnull","isnotnull"])>-1){b(this).next().hide();b(this).next().val("1")}else{if(b(this).next()=="none"){b(this).next().val("")}b(this).next().show()}});if(k=="date"){h.find(".date").datetimepicker({clearBtn:false,autoclose:true,format:"dd/mm/yyyy hh:ii"})}else{if(k=="dateTime"){h.find(".date").datetimepicker({minView:2,autoclose:true,clearBtn:false,startView:2,format:"dd/mm/yyyy"})}else{if(k=="time"){h.find(".date").datetimepicker({minView:0,format:"hh:ii",clearBtn:false,maxView:1,autoclose:true,startView:1})}}}h.find("input,select,textarea").jqBootstrapValidation();h.data({name:f,type:k,id:g,tablename:i,valuetype:p});c.drop_new_operation(j,h);h.find(".connector").click(o.changeConnector);b(".close").tooltip()};c.prototype.drop_new_condition=function(h,i,e){var f=this;var g=b(i.draggable).clone();var d=b(ich.condition());f.drop_new_single_operation(h,i,d);e.before(d);d.droppable({activeClass:"new-condition-active",hoverClass:"condition-hover",drop:function(j,k){f.drop_new_single_operation(j,k,d)}});d.children(".connector").click(f.changeConnector);b(".close").tooltip()};c.prototype.drop_new_select=function(d,i,j){var m=this;var k=b(i.draggable).clone();var e=k.data("name");var h=k.data("type");var f=k.attr("id");var g=k.data("tablename");if(j.parent().find("."+f).length){k.remove();b("#select-message-error").text("This column is already in the select statement!").fadeIn().delay(5000).slideUp();return false}var l=b(ich.select({id:f,name:e}));l.data({name:e,type:h,id:f,tablename:g});j.before(l);l.find(".close").tooltip()};c.prototype.validation=function(){var d=this;if(d.$root.find("#select-columns > .select:not(.new-select)").length==0){b("#select-message-error").text("Please, select at least one column.").fadeIn().delay(5000).slideUp();b("#myTab a:first").tab("show");return false}if(d.$root.find("#where > .condition:not(.new-condition)").length==0){b("#where-message-error").text("Please, define at least one -where- condition.").fadeIn().delay(5000).slideUp();b("#myTab a:last").tab("show");return false}var e=d.$root.find("input,select,textarea").jqBootstrapValidation("collectErrors");for(key in e){if(e[key].length){b("#where-message-error").text(key+" assignment error. Please check if the inserted value is missing or a wrong type value.").fadeIn().delay(5000).slideUp();b("#myTab a:last").tab("show");b("input[name="+key+"]").focus();return false}}return true};c.prototype.generateQuery=function(){var d=this;b("#myTab a:last").tab("show");d.$dropArea={select:[],where:[]};if(d.validation()){d.$root.find("#where > .condition:not(.new-condition)").each(function(g,h){var f=b(h);if(f.find(".inside-condition").length>0){var e="";if(f.children(".connector:visible").length>0){e=b(f.children(".connector:visible")[0]).hasClass("and")?"and":"or"}var i={group:[],connector:e};f.find(".inside-condition").each(function(){var j=b(this);i.group.push({name:j.data("name"),type:j.data("type"),tablename:j.data("tablename"),operator:j.find(".operator:first").val(),value:j.find("input:first").val(),valueType:j.data("valuetype"),connector:j.children(".connector:visible").length>0?b(j.children(".connector:visible")[0]).hasClass("and")?"and":"or":""})});d.$dropArea.where.push(i)}});d.$root.find("#select-columns > .select:not(.new-select)").each(function(g,h){var e=b(h);var f;if(e.find(".condition-form").length>0){f={name:e.data("name"),type:e.data("type"),tablename:e.data("tablename"),displayAs:e.find("input:first").val()};d.$dropArea.select.push(f)}});return true}else{return false}};c.prototype.submit_query=function(){var d=this;if(d.validation()){d.generateQuery();b.ajax({type:"POST",url:"/get_results/",dataType:"json",data:{globalID:d.$globalID,query:JSON.stringify(d.$dropArea)},success:function(e){d.getReults(e)},fail:function(e){alert("Some errors occurs, retry")}})}else{b("#query_button").button("reset")}};c.prototype.getReults=function(e){var d=this;var h=[];var f=function(j,i,l,k){if(j===undefined){return j}if(j.indexOf("https://lobcder.vph.cyfronet.pl/lobcder/dav/")>-1){return"<a target='blank' href='"+j.replace("https://lobcder.vph.cyfronet.pl/lobcder/dav","/filestore#show?")+"'>"+j.replace("https://lobcder.vph.cyfronet.pl/lobcder/dav/","lobcder://")+"</a>"}else{if(j.indexOf("http")>-1){return"<a target='blank' href='"+j+"'>"+j+"</a>"}}return j};for(column in e.header){h.push({title:e.header[column],render:f})}var g=b('<table cellpadding="0" cellspacing="0" border="0" class="display cell-border" id="dataset-results-table"></table>');b("#query-results > .span12").empty();g.appendTo("#query-results > .span12");b("#query-results").show();b("#hr-query-results").show();g.dataTable({columns:h,data:e.results,paging:true,ordering:true,info:true,search:true,scrollX:true,dom:'T<"clear">lfrtip',tableTools:{sSwfPath:"/static/swf/copy_csv_xls_pdf.swf"},language:{search:"<i class='icon-search'></i>",paginate:{previous:"«",next:"»"}}});b("#query_button").button("reset")};c.prototype.saveQuery=function(){var d=this;b("#save-query").button("loading");if(!d.generateQuery()){b("#save-query").button("reset");b("#save-query-modal").modal("toggle");return false}if(b("#save-query-input").val()==""){b("#save-query").button("reset");return false}var e=b("#save-query-input").val();b.ajax({type:"POST",url:"/edit_the_query/",dataType:"json",data:{globalID:d.$globalID,query:JSON.stringify(d.$dropArea),name:e,q:d.$queryid},success:function(f){if(f.saved){window.location.replace("/query_builder/"+d.$globalID+"/?q="+f.id)}},fail:function(f){alert("Some errors occurs, retry")}})};c.prototype.saveAsQuery=function(){var d=this;b("#saveas-query").button("loading");if(!d.generateQuery()){b("#saveas-query").button("reset");b("#saveas-query-modal").modal("toggle");return false}if(b("#saveas-query-input").val()==""){b("#saveas-query").button("reset");return false}var e=b("#saveas-query-input").val();b.ajax({type:"POST",url:"/save_the_query/",dataType:"json",data:{globalID:d.$globalID,query:JSON.stringify(d.$dropArea),name:e},success:function(f){if(f.saved){window.location.replace("/query_builder/"+d.$globalID+"/?q="+f.id)}},fail:function(f){alert("Some errors occurs, retry")}})};c.prototype.loadtables=function(){var d=this;d.$root.find(".dataset-table").each(function(){b(this).dataTable({dom:"<'row-fluid'<'span12'f>r><'row-fluid'<'span12'p>><'row-fluid'<'span12't>>",columns:[{title:""}],paging:true,ordering:false,info:false,search:true,scrollX:true,language:{search:"<i class='icon-search'></i>",paginate:{previous:"«",next:"»"}}})})};c.autoDiscover=function(){var d=b("#query-builder");new c(d)}}).call(this);